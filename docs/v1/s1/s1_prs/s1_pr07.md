# agency slice 01 — pr-07: setup script execution + logging (v1 mvp)

## goal

implement the `RunSetup` step: execute the repo’s `scripts.setup` **outside tmux** in the worktree, with the injected `AGENCY_*` environment + 10 minute timeout, and record deterministic evidence (logs + meta fields) on success/failure.

---

## scope

### in-scope

- implement the previously-stubbed `RunSetup` pipeline step (introduced in pr-04) so that, **after**:
  - repo gates (pr-02)
  - config resolution (pr-03)
  - worktree + scaffolding (pr-05)
  - run dir + initial meta (pr-06)

  the setup step:

  1) runs the configured setup script string via shell:
     - command: `sh -lc <setup_script>`
     - cwd: `<worktree_path>`
     - stdin: `/dev/null`
     - timeout: **10 minutes** (hardcoded v1)
     - env: inherit process env + inject `AGENCY_*` + `CI=1` (exact list below)

  2) captures stdout/stderr deterministically to:
     - `${AGENCY_DATA_DIR}/repos/<repo_id>/runs/<run_id>/logs/setup.log`
     - **truncate** the log file on each setup attempt (overwrite, not append)

  3) updates `meta.json` with setup evidence:
     - on success: write `setup.*` fields (exit_code/duration/etc.) and ensure `flags.setup_failed` is unset/false
     - on failure/timeout: set `flags.setup_failed=true` and populate `setup.*` fields

  4) optional structured output support (per l0 contract):
     - if `<worktree>/.agency/out/setup.json` exists after the script runs, parse it (schema below)
     - if parsed and `ok == false`, treat setup as failed (even if exit code was 0)
     - store `setup.output_ok` and `setup.output_summary` in meta if present

- ensure `RunPipeline` short-circuits: if setup fails, later steps are not executed.

### out-of-scope

- no tmux session creation (pr-08)
- no `agency attach` work beyond what exists
- no verify/archive scripts
- no github/PR operations
- no transcript capture
- no retries
- no concurrency/locking

---

## public surface area

### persistent formats changed

- `${AGENCY_DATA_DIR}/repos/<repo_id>/runs/<run_id>/meta.json`:
  - add `setup` object fields (additive only)

### error codes used (no new codes)

- `E_SCRIPT_TIMEOUT` — setup exceeded 10 minutes
- `E_SCRIPT_FAILED` — setup exited non-zero OR setup.json `ok=false` OR setup execution failed (spawn error)

---

## required behavior

### shell execution contract

- setup script is a single command string resolved from `agency.json scripts.setup` (pr-03).
- execution is performed as:
  - `sh`, args: `-lc`, `<setup_script>`
- agency must not attempt to parse or escape `<setup_script>`; it is passed as-is as the `-c` program.

### env injection (exact)

inherit `os.Environ()` plus/overrides:

- `AGENCY_RUN_ID`
- `AGENCY_TITLE`
- `AGENCY_REPO_ROOT`
- `AGENCY_WORKSPACE_ROOT`
- `AGENCY_BRANCH`
- `AGENCY_PARENT_BRANCH`
- `AGENCY_ORIGIN_NAME`
- `AGENCY_ORIGIN_URL`
- `AGENCY_RUNNER` (runner name: `claude|codex`)
- `AGENCY_PR_URL` (empty string)
- `AGENCY_PR_NUMBER` (empty string)
- `AGENCY_DOTAGENCY_DIR` (=`<worktree>/.agency/`)
- `AGENCY_OUTPUT_DIR` (=`<worktree>/.agency/out/`)
- `AGENCY_LOG_DIR` (=`${AGENCY_DATA_DIR}/repos/<repo_id>/runs/<run_id>/logs/`)
- `AGENCY_NONINTERACTIVE=1`
- `CI=1`

stdin must be null:
- `cmd.Stdin = nil` or explicitly open `/dev/null` read-only

### log file contract

- path: `${...}/logs/setup.log`
- truncate/overwrite each attempt
- include both stdout and stderr in the file in a deterministic way (acceptable approaches):
  - write stdout then stderr with clear headers, OR
  - stream interleaved combined output (preferred if helper supports it)
- if setup fails, error output must include:
  - the exact command (`sh -lc <setup_script>`)
  - the log path

### optional structured output contract (setup.json)

if `<worktree>/.agency/out/setup.json` exists and parses as json object:

```json
{
  "schema_version": "1.0",
  "ok": true,
  "summary": "one-line description",
  "data": {}
}

rules:
	•	only ok and summary are used in v1
	•	if ok is false, treat setup as failed (E_SCRIPT_FAILED)
	•	if file exists but is invalid json, ignore it (do not fail setup because of a malformed optional artifact)

meta.json fields (additive)

after setup attempt, update meta.json with:
	•	flags.setup_failed: boolean (true on failure/timeout, false/absent on success)
	•	setup object:
	•	command: string (exactly sh -lc <setup_script> rendered as two fields or one; choose one and keep stable)
	•	exit_code: int (0 if success; non-zero if script returned non-zero; use -1 if process failed to start)
	•	duration_ms: int
	•	timed_out: boolean
	•	log_path: string (absolute path)
	•	output_ok: optional boolean (only if setup.json present and parsed)
	•	output_summary: optional string (only if setup.json present and parsed)

notes:
	•	do not set tmux_session_name in this pr
	•	json writes must remain atomic (helper from pr-01)

⸻

acceptance (given/when/then)

1) setup success writes log + meta

given
	•	worktree exists and .agency/ dirs exist
	•	run dir exists with initial meta.json
	•	setup script prints to stdout and touches a sentinel file in .agency/tmp/

when
	•	RunSetup executes

then
	•	returns success
	•	logs/setup.log exists and contains the script output
	•	meta.json updated with:
	•	flags.setup_failed absent or false
	•	setup.exit_code == 0
	•	setup.timed_out == false
	•	setup.log_path points to setup.log
	•	setup.duration_ms > 0
	•	sentinel file exists in .agency/tmp/

2) setup non-zero exit sets flags.setup_failed

given
	•	setup script exits 2

when
	•	RunSetup executes

then
	•	returns AgencyError with code E_SCRIPT_FAILED
	•	meta.json updated with:
	•	flags.setup_failed == true
	•	setup.exit_code == 2
	•	setup.timed_out == false
	•	no tmux is started (pipeline short-circuit)

3) setup timeout sets flags.setup_failed and timed_out

given
	•	setup script sleeps longer than 10 minutes (test uses a shorter timeout via injectable clock/override if available; otherwise mark integration test as long-running and skip by default)

when
	•	RunSetup executes

then
	•	returns AgencyError with code E_SCRIPT_TIMEOUT
	•	meta.json updated with:
	•	flags.setup_failed == true
	•	setup.timed_out == true
	•	setup.exit_code reflects timeout (implementation-defined; recommended: -1)

4) setup.json ok=false forces failure

given
	•	setup script exits 0
	•	setup script writes <worktree>/.agency/out/setup.json with "ok": false

when
	•	RunSetup executes

then
	•	returns E_SCRIPT_FAILED
	•	meta includes setup.output_ok == false and setup.output_summary (if present)
	•	flags.setup_failed == true

5) setup.json malformed is ignored

given
	•	setup script exits 0
	•	setup script writes invalid json to .agency/out/setup.json

when
	•	RunSetup executes

then
	•	setup still succeeds (exit 0 governs)
	•	meta does not include setup.output_ok / setup.output_summary

⸻

tests

unit tests (required)
	•	TestSetupMetaUpdate_Success:
	•	simulate a command that exits 0 and produces output
	•	assert meta updated fields and flags.setup_failed false/absent
	•	assert log truncation behavior by running setup twice and ensuring only latest output is present (if easy; otherwise optional)
	•	TestSetupJsonOkFalse_ForcesFailure:
	•	arrange for .agency/out/setup.json to exist with ok=false
	•	assert E_SCRIPT_FAILED and meta fields output_ok/output_summary
	•	TestSetupJsonMalformed_Ignored:
	•	invalid json does not fail the step

integration tests (recommended)

use a temp git repo + real worktree creation from earlier PRs, then:
	•	success script:
	•	./scripts/agency_setup.sh prints, touches .agency/tmp/sentinel, exits 0
	•	failure script:
	•	exits 7
	•	structured output script:
	•	writes .agency/out/setup.json ok=false, exits 0

assert:
	•	meta updates
	•	logs present

timeout test:
	•	only include if you can inject timeout into RunSetup via dependency (e.g. SetupTimeout field in opts used only in tests). if not available, skip automated timeout test and keep it as manual only.

⸻

guardrails
	•	do not create or modify tmux sessions
	•	do not add any new commands/flags
	•	do not implement resume/stop/kill/ls/push/merge
	•	do not modify the parent working tree
	•	do not add third-party deps
	•	do not change any directory layout or schemas beyond the additive setup meta fields described here
	•	do not append to setup.log; must truncate each attempt

⸻

definition of done
	•	go test ./... passes
	•	setup step executes successfully in a real temp repo and updates meta/logs exactly as specified
	•	failure paths set flags.setup_failed and return the correct error code
	•	no tmux-related code is introduced in this pr

⸻

claude prompt pack (implementation)

from repo root:
	1.	run tests

go test ./...

	2.	implement pr-07 exactly:

	•	locate pipeline RunSetup stub from pr-04 and implement it.
	•	run setup via sh -lc <setup_script> in the worktree with stdin null and env injection.
	•	truncate logs/setup.log and write output.
	•	update meta atomically with setup.* fields and flags.setup_failed on failure.
	•	add optional parsing of .agency/out/setup.json (ok/summary only) with the rules above.

	3.	run tests again

go test ./...

constraints:
	•	no tmux code.
	•	no new commands.
	•	no additional persistent formats.
