# agency slice 01 — pr-08: tmux session creation + `agency attach` (v1 mvp)

## goal

on successful setup, start a **detached** tmux session running a **real** `claude`/`codex` tui in the worktree, persist `tmux_session_name` in `meta.json`, and implement `agency attach <run_id>` to attach to that session (with crisp error handling when missing).

---

## scope

### in-scope

#### A) tmux session creation step (`StartTmux`)

- implement the previously-stubbed `StartTmux` pipeline step (introduced in pr-04) such that **only when setup succeeded** (pr-07):
  1) create a tmux session named `agency:<run_id>` **detached**
  2) ensure the pane command runs the runner inside the worktree via shell:
     - `sh -lc 'cd <escaped_worktree_path> && exec <runner_cmd>'`
     - `<escaped_worktree_path>` MUST be posix shell-escaped (helper from pr-01)
     - `<runner_cmd>` MUST be inserted verbatim (no parsing, no escaping)
  3) on success:
     - update `${...}/runs/<run_id>/meta.json` to include `tmux_session_name`
  4) on failure:
     - return `AgencyError` with correct error code
     - set `flags.tmux_failed=true` in meta
     - **do not** set `tmux_session_name`

- enforce collision behavior:
  - if a tmux session already exists with that name, return `E_TMUX_SESSION_EXISTS` (no attempt to reuse/attach)
  - do not set `flags.tmux_failed` on collision

#### B) `agency attach <run_id>` command

- implement `agency attach <run_id>` (no resume behavior in this PR):
  - resolve repo root from CWD
  - compute `repo_id` using S0 rules (reuse existing code)
  - load meta from `${AGENCY_DATA_DIR}/repos/<repo_id>/runs/<run_id>/meta.json`
  - attach to tmux session:
    - use the `tmux_session_name` in meta
    - if `tmux_session_name` is missing, return `E_TMUX_SESSION_MISSING`
  - invocation:
    - always run `tmux attach -t <session>` (works inside/outside tmux; do not use switch-client in v1)
  - return exit code 0 when user detaches/exits the tmux client

- attach error cases:
  - if run_id not found in this repo: `E_RUN_NOT_FOUND`
  - no cross-repo attach in v1: treat as `E_RUN_NOT_FOUND`
- if run is known but tmux session missing: `E_TMUX_SESSION_MISSING` with actionable output:
  - print `worktree_path`
  - print `runner_cmd`
  - print suggested manual command:
    - `cd "<worktree_path>" && <runner_cmd>`

### out-of-scope

- no `resume`, `stop`, `kill`, `ls`, `show`, `clean`
- no pid inspection
- no transcript capture (tmux scrollback remains tmux-native)
- no github/PR operations

---

## public surface area

### commands

- `agency attach <run_id>` (added / implemented in this PR)

(no new flags)

### persistent formats changed (additive only)

- `meta.json` additions:
  - `tmux_session_name` (string) — set only on successful tmux creation
  - `flags.tmux_failed` (boolean) — set on tmux creation failure

---

## error codes

### new / required in this PR (must exist in public list)

- `E_TMUX_SESSION_EXISTS` — tmux session name collision (`agency:<run_id>` already exists)
- `E_TMUX_FAILED` — tmux command returned non-zero when creating session
- `E_TMUX_SESSION_MISSING` — attach requested but tmux session does not exist for a known run

(existing error codes used)
- `E_TMUX_NOT_INSTALLED`
- `E_NO_REPO`
- `E_RUN_NOT_FOUND`
- (no E_RUN_REPO_MISMATCH in v1; repo-scoped attach only)

---

## required behavior

### tmux start contract

- session name: `agency:<run_id>`
- tmux_session_name written to meta must equal `agency:<run_id>`
- tmux create command must:
  - be non-interactive
  - be detached
  - start in one window/pane (default)
  - run the pane command exactly as built by helper(s) from pr-01:
    - `sh -lc 'cd <escaped_worktree_path> && exec <runner_cmd>'`

implementation guidance (not user-visible but should be deterministic):
- use `tmux new-session -d -s <session> -c <worktree_path> <pane_command>`
  - BUT note: passing `-c` plus also `cd` is redundant. choose one.

**choose one and lock it:**

**locked approach (recommended):**
- do **not** rely on tmux `-c` portability; instead:
  - `tmux has-session -t <session>`
  - `tmux new-session -d -s <session> -- sh -lc 'cd <escaped_worktree_path> && exec <runner_cmd>'`

tmux interface (for tests):
```go
type Tmux interface {
  HasSession(name string) error
  NewSession(name string, cmd string) error
  Attach(name string) error
}
```

### meta update rules

- on successful tmux creation:
  - update meta.json atomically to include:
    - `tmux_session_name`: `agency:<run_id>`
  - ensure `flags.tmux_failed` is absent or false

- on tmux failure:
  - update meta.json atomically to include:
    - `flags.tmux_failed=true`
  - ensure `tmux_session_name` is absent
  - do not modify other fields (read-modify-write)

### attach contract

- `agency attach <run_id>` must:
  - validate tmux is installed
  - ensure meta exists for this run_id in this repo_id
  - ensure tmux session exists:
    - `tmux has-session -t <session>`
  - if missing, return `E_TMUX_SESSION_MISSING` and print manual fallback steps
  - else, run `tmux attach -t <session>` and block until detach

---

## behaviors (given / when / then)

### 1) tmux started after setup success

**given**
- run exists with meta.json
- setup step succeeded (`flags.setup_failed` absent/false and `setup.exit_code == 0`)
- runner_cmd exists in meta
- tmux installed

**when**
- `StartTmux` step executes

**then**
- tmux session `agency:<run_id>` exists
- meta.json updated to include `tmux_session_name="agency:<run_id>"`

### 1a) setup failed guard

**given**
- run exists with meta.json
- setup step failed (`flags.setup_failed == true` or `setup.exit_code != 0`)

**when**
- `StartTmux` step executes

**then**
- return `E_TMUX_FAILED` with message "setup failed"
- do not start tmux

### 2) tmux collision

**given**
- tmux session `agency:<run_id>` already exists

**when**
- `StartTmux` executes

**then**
- return non-zero error `E_TMUX_SESSION_EXISTS`
- `tmux_session_name` remains absent

### 3) tmux creation fails

**given**
- tmux returns non-zero (simulate by mocking tmux binary in PATH or injecting a failing command in test)

**when**
- `StartTmux` executes

**then**
- return `E_TMUX_FAILED`
- meta updated with `flags.tmux_failed=true`
- `tmux_session_name` absent

### 4) attach known run, session exists

**given**
- cwd inside the correct repo
- `${...}/meta.json` exists for run_id
- tmux session exists

**when**
- `agency attach <run_id>`

**then**
- attaches to the session
- exits 0 when user detaches

### 5) attach unknown run

**given**
- meta.json for run_id does not exist under this repo_id

**when**
- `agency attach <run_id>`

**then**
- exit non-zero `E_RUN_NOT_FOUND`

### 6) attach known run, session missing

**given**
- meta.json exists
- tmux session does not exist

**when**
- `agency attach <run_id>`

**then**
- exit non-zero `E_TMUX_SESSION_MISSING`
- print:
  - `worktree_path`
  - `runner_cmd`
  - suggested manual command: `cd "<worktree_path>" && <runner_cmd>`

---

## tests

### unit tests (required)

- `TestBuildRunnerShell_IncludesEscapedWorktreeAndRunnerCmd` (only if helper tests are not already present from PR-01):
  - ensures worktree path is shell-escaped
  - ensures runner_cmd is inserted verbatim (no escaping)

- `TestStartTmux_UpdatesMetaOnSuccess`:
  - use a tmux interface fake (see below)
  - assert meta updated with `tmux_session_name`

- `TestStartTmux_SetsTmuxFailedOnError`:
  - simulate tmux command failure and assert meta flag set and session name absent

- `TestAttach_UsesMetaSessionNameOnly`:
  - if tmux_session_name missing, assert E_TMUX_SESSION_MISSING

### integration tests (recommended, but keep expectations minimal)

tmux is hard to automate; keep tests to existence checks:

- after running through steps up to `StartTmux`, assert:
  - `tmux has-session -t agency:<run_id>` returns 0

do **not** attempt to assert “lands in runner pane” in CI. that remains manual.

### manual smoke (required)

- run through `agency run` end-to-end up to this PR’s capabilities (or use internal harness):
  1) create run with a runner that exists (e.g. `runners.claude="sh"` for smoke)
  2) verify `tmux ls | grep agency:<id>`
  3) `agency attach <id>` and confirm it attaches

---

## guardrails

- do not implement resume/stop/kill/ls/show
- do not add any github/PR behavior
- do not add pid inspection or transcript capture
- do not introduce new persistent formats beyond meta additions
- do not add third-party deps
- do not modify `.gitignore`
- do not start tmux if setup failed (pipeline must short-circuit)
- do not attach if tmux_session_name is missing in meta

---

## definition of done

- `go test ./...` passes
- successful runs create a detached tmux session and write `tmux_session_name` to meta
- tmux failures set `flags.tmux_failed=true` and return correct error codes
- `agency attach <run_id>` attaches when session exists; returns deterministic errors otherwise

---

## implementation prompt (optional)

from repo root:

1) run tests
```bash
go test ./...
```

2) implement pr-08 exactly:
- implement StartTmux pipeline step:
  - build pane command via helper(s)
  - run `tmux has-session` then `tmux new-session -d -s ... -- sh -lc ...`
  - update meta with session name on success or flags.tmux_failed on failure
- implement agency attach <run_id>:
  - resolve repo root + repo_id
  - load meta
  - tmux has-session gate
  - tmux attach -t ... when present
  - error codes and messages per spec

3) run tests
```bash
go test ./...
```

constraints:
- no new commands besides attach
- no resume logic
- keep tmux automation minimal and deterministic
