# agency slice 01 — pr-05 spec: worktree creation + workspace scaffolding + ignore warning

## goal

implement the `CreateWorktree` step for slice 01: deterministically create a new git worktree + branch from a **local** parent branch, scaffold workspace-local `.agency/` directories + `report.md`, and emit a best-effort warning when `.agency/` is not gitignored.

---

## scope

### in-scope

- implement `CreateWorktree` (used by `RunPipeline`) to:
  - compute `run_id`-scoped branch name: `agency/<slug>-<shortid>`
  - compute worktree path: `${AGENCY_DATA_DIR}/repos/<repo_id>/worktrees/<run_id>/`
  - create branch + worktree in one command:
    - `git worktree add -b <branch> <worktree_path> <parent_branch>`
  - create workspace-local directories:
    - `<worktree>/.agency/`
    - `<worktree>/.agency/out/`
    - `<worktree>/.agency/tmp/`
  - create `<worktree>/.agency/report.md` if missing (template; title prefilled)
    - if it exists: leave as-is (no rewrite)
  - run `.agency/` ignore check (best-effort):
    - `git -C <worktree> check-ignore -q .agency/`
    - if exit code == 1: record a **warning** in pipeline state (do not fail)
    - if exit code == 0: ignored (no warning)
    - if exit code == 128: treat as unknown (no warning)
- surface failures as `AgencyError` with:
  - `code = E_WORKTREE_CREATE_FAILED`
  - `details` includes:
    - exact git command string executed
    - stderr and stdout (separately) if available
    - truncate each stream to at most 32KB; include `truncated=true` if truncation occurs

### out-of-scope

- no `meta.json` writes (PR-06)
- no setup script execution (PR-07)
- no tmux session creation (PR-08)
- no CLI wiring (PR-09)
- no deletion/cleanup on failure
- no git fetch/checkout/rebase/reset

---

## public surface area added/changed

### internal api

`CreateWorktree` must exist as a callable step from the pipeline layer.

recommended signature (internal package; adjust to match your pipeline design):

```go
func CreateWorktree(ctx context.Context, st *pipelineState) error

requirements:
	•	must read from pipeline state:
	•	st.RunID
	•	st.Opts.Title (may be empty)
	•	st.Repo.RepoRoot (absolute)
	•	st.Repo.RepoID
	•	st.Resolved.ParentBranch (string; must already be validated by PR-02)
	•	must write into pipeline state:
	•	st.Derived.Branch
	•	st.Derived.WorktreePath
	•	st.Derived.Title (resolved title used for slug/template)
	•	st.Warnings append (if .agency/ not ignored)

internal helper split (recommended):
	•	createGitWorktree(...) (one-shot; non-idempotent)
	•	scaffoldWorkspace(...) (idempotent; can be called independently in tests)

no additional exported APIs.

⸻

error codes

this PR must use existing codes only:
	•	E_WORKTREE_CREATE_FAILED — any failure from git worktree add or filesystem scaffolding
	•	(do not add new error codes in this PR)

note: collisions (branch exists, path exists, already checked out) are all folded into E_WORKTREE_CREATE_FAILED for v1 MVP.

⸻

behavior (given / when / then)

1) successful create

given
	•	pipeline state contains:
	•	a valid run_id
	•	a repo root with at least one commit
	•	a validated local parent_branch (exists)
	•	target worktree path does not exist (git will enforce this)

when
	•	CreateWorktree(ctx, st)

then
	•	creates worktree and branch via:
	•	git worktree add -b <branch> <worktree_path> <parent_branch>
	•	sets:
	•	st.Derived.Branch = <branch>
	•	st.Derived.WorktreePath = <worktree_path>
	•	set these only after git worktree add succeeds
	•	ensures directories exist:
	•	<worktree>/.agency/, <worktree>/.agency/out/, <worktree>/.agency/tmp/
	•	creates <worktree>/.agency/report.md if missing with template:
	•	title line: # <resolved_title>
	•	body template (exact):
	•	## summary
	•	- ...
	•	## plan
	•	- ...
	•	## progress
	•	- ...
	•	## notes
	•	- ...
	•	performs ignore check:
	•	if .agency/ not ignored: adds a warning to state (no failure)

2) report already exists

given
	•	<worktree>/.agency/report.md already exists

when
	•	CreateWorktree(...)

then
	•	do not overwrite or modify the existing file (leave unchanged)

3) worktree creation fails (any reason)

given
	•	git worktree add ... returns non-zero (including collisions)

when
	•	CreateWorktree(...)

then
	•	return AgencyError{ code: E_WORKTREE_CREATE_FAILED, ... }
	•	include:
	•	exact git command string
	•	stderr / output
	•	do not attempt cleanup or deletion

⸻

command execution (must be exact)

git commands

run with -C <repo_root> (do not change process cwd):
	•	git -C <repo_root> worktree add -b <branch> <worktree_path> <parent_branch>

preflight:
	•	do not preflight worktree path existence; rely on git error

ignore check

run with:
	•	git -C <worktree_path> check-ignore -q .agency/
	•	git -C <worktree_path> check-ignore -q .agency/report.md

exit code handling:
	•	0 => ignored
	•	1 => not ignored (warn)
	•	128 => unknown/error (ignore silently)

warning structure:
	•	append Warning{Code: "W_AGENCY_NOT_IGNORED", Message: ".agency/ is not ignored; run agency init"}
	•	Warnings is []Warning in pipeline state (struct with Code, Message)

⸻

derived values (must match slice 01 spec)

title resolution
	•	if st.Opts.Title non-empty: use it
	•	else: use untitled-<shortid> where <shortid> is derived from run_id exactly as in PR-01 utilities
	•	store resolved title in st.Derived.Title for later meta/report usage
	•	do not include the timestamp component in the default title

slug rules

use the shared slugify utility from PR-01. do not create a second slugifier.

branch name format

agency/<slug>-<shortid>

where:
	•	<slug> comes from resolved title (lowercase, hyphens, max length per PR-01 rules)
	•	<shortid> is the same short component used in the slice spec/roadmap

worktree path

must be exactly:

${AGENCY_DATA_DIR}/repos/<repo_id>/worktrees/<run_id>/

using the shared path helpers from PR-01 (no duplication).

⸻

files created/modified

in the worktree (workspace-local)
	•	<worktree>/.agency/
	•	<worktree>/.agency/out/
	•	<worktree>/.agency/tmp/
	•	<worktree>/.agency/report.md (created only if missing)

global state
	•	no agency-managed global metadata files written in this PR (meta/logs are PR-06/07)
	•	worktree filesystem changes under ${AGENCY_DATA_DIR} are expected

⸻

tests

automated (required)

integration tests (required)
create temp repos with real git commands; no tmux.

test cases:
	1.	creates worktree + scaffolding

	•	setup:
	•	init temp repo, make 1 commit
	•	create local parent branch (e.g. main)
	•	construct pipeline state with run_id + repo_root + repo_id + parent_branch + title
	•	call CreateWorktree
	•	assert:
	•	worktree dir exists
	•	.agency/, out/, tmp/ exist
	•	report.md exists and contains # <title> as first heading
	•	branch name matches agency/<slug>-<shortid>

	2.	report not overwritten

	•	after successful create, write a sentinel string into report.md
	•	call scaffoldWorkspace again
	•	assert sentinel remains unchanged

	3.	collision returns E_WORKTREE_CREATE_FAILED

	•	create a worktree once
	•	attempt create again with the same run_id (same worktree path)
	•	assert error code E_WORKTREE_CREATE_FAILED
	•	assert error details include the git command and stderr/output

notes:
	•	do not require .agency/ ignore warning in tests (depends on ignore config); if you want, set up a .gitignore that does NOT ignore .agency/ and assert that a warning is recorded in pipeline state.
	•	report template assertions should match the exact template above

manual verification (optional)
	•	run pipeline through PR-04 harness (if present) until CreateWorktree step and inspect:
	•	git worktree list
	•	.agency/ scaffolding in the worktree

⸻

guardrails
	•	do not write meta.json or any global run directory content
	•	do not delete worktrees or branches on failure
	•	do not run git worktree prune or modify existing worktrees
	•	do not run any scripts
	•	do not start tmux
	•	do not add new third-party dependencies
	•	do not change git state beyond git worktree add (no fetch/checkout)

⸻

definition of done
	•	CreateWorktree implemented and integrated into pipeline step ordering
	•	branch/worktree creation works on a real temp repo
	•	scaffolding dirs + report template created correctly
	•	collisions surface as E_WORKTREE_CREATE_FAILED with actionable stderr/command details
	•	go test ./... passes
