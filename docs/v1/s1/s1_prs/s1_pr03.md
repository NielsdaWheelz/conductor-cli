# agency slice 01 — pr-03 spec: agency.json load + validation + runner resolution (read-only)

## goal

load and validate `agency.json` at a provided repo root for slice 01 needs, and
resolve the **setup script** and **runner command** strings deterministically
(no execution).

---

## scope

### in-scope

- read `agency.json` from repo root (caller provides repoRoot; no git calls)
- parse json and validate the subset required by slice 01:
  - `version == 1`
  - `defaults.parent_branch` is a non-empty string
  - `defaults.runner` is a non-empty string
  - `scripts.setup` is a non-empty string
  - note: later slices enforce verify/archive; this PR validates only S1 needs
- resolve the runner command string used by slice 01:
  - runnerName := defaults.runner (case-sensitive)
  - if `runners[runnerName]` exists: use its string value **verbatim**
  - else if runnerName is exactly `claude` or `codex`: use literal `claude` / `codex`
  - else: error `E_RUNNER_NOT_CONFIGURED`
- produce a single resolved config object consumed by later s1 steps:
  - parent branch default
  - runner default
  - setup script command string (shell snippet)
  - runner command string (shell snippet)

### out-of-scope

- do not execute or validate scripts
- do not check existence of runner binary (doctor owns that)
- do not modify any files (read-only)
- do not add new required fields to `agency.json`
- no support for config overrides, per-directory configs, monorepo overrides, or env-based config

---

## public surface area added/changed

### internal api

add a single internal entrypoint:

```go
// LoadAgencyConfig reads and validates agency.json at repo root and returns
// the resolved values used by slice 01.
func LoadAgencyConfig(repoRoot string) (*AgencyConfig, error)

type AgencyConfig struct {
  Version int

  Defaults struct {
    ParentBranch string // json:"parent_branch"
    Runner       string // json:"runner"
  }

  Scripts struct {
    Setup   string // json:"setup"
    Verify  string // may be empty; ignored in s1
    Archive string // may be empty; ignored in s1
  }

  // RunnerCmd is the resolved command string to execute in tmux pane.
  RunnerCmd string

  // SetupScript is the configured shell command string for setup.
  SetupScript string
}

notes:
- Verify/Archive fields may exist in the struct for forward compatibility but
  must not be validated as required in this pr.
- Do not export additional config loaders unless necessary.
- Parse using typed structs; do not accept "1.0" or "1" for version.
- All errors must be *AgencyError with stable Code and Details (path, key,
  expected, got).
- Runner names are case-sensitive.
- RunnerCmd is stored verbatim; do not trim or normalize.

⸻

behaviors (given / when / then)

1) valid config resolves runner and setup script

given
	•	repoRoot contains a valid agency.json with:
	•	version: 1
	•	defaults.parent_branch: "main"
	•	defaults.runner: "claude"
	•	scripts.setup: "./scripts/agency_setup.sh"
	•	optional runners.claude: "claude --some-flag"

when
	•	LoadAgencyConfig(repoRoot)

then
	•	returns AgencyConfig where:
	•	Defaults.ParentBranch == "main"
	•	Defaults.Runner == "claude"
	•	SetupScript == "./scripts/agency_setup.sh" (verbatim)
	•	RunnerCmd == "claude --some-flag" (verbatim)

⸻

2) runners. missing but defaults.runner is builtin

given
	•	defaults.runner is "claude"
	•	runners omits "claude"

when
	•	LoadAgencyConfig(...)

then
	•	RunnerCmd == "claude"

same for "codex".

⸻

3) runner not configured

given
	•	defaults.runner is "my_runner"
	•	runners.my_runner is missing

when
	•	LoadAgencyConfig(...)

then
	•	error code E_RUNNER_NOT_CONFIGURED

⸻

4) invalid version

given
	•	version != 1

when
	•	LoadAgencyConfig(...)

then
	•	error code E_INVALID_AGENCY_JSON
	•	error message includes: version must be 1

4a) missing version

given
	•	version is missing

when
	•	LoadAgencyConfig(...)

then
	•	error code E_INVALID_AGENCY_JSON
	•	error message includes: missing required key: version

⸻

5) missing required keys

given
	•	any of the required fields are missing or empty strings:
	•	defaults.parent_branch
	•	defaults.runner
	•	scripts.setup

when
	•	LoadAgencyConfig(...)

then
	•	error code E_INVALID_AGENCY_JSON
	•	error message names the missing key (e.g. defaults.parent_branch)

⸻

6) type validation

given
	•	runners exists but:
	•	is not an object, or
	•	contains non-string values

when
	•	LoadAgencyConfig(...)

then
	•	error code E_INVALID_AGENCY_JSON

same for scripts.setup not being a string, etc.

⸻

error codes

this pr must use these codes:
	•	E_NO_AGENCY_JSON — file missing at <repoRoot>/agency.json
	•	E_INVALID_AGENCY_JSON — invalid json, wrong types, missing required keys, or invalid version
	•	E_RUNNER_NOT_CONFIGURED — runner name not found in runners and not builtin claude|codex

do not introduce new error codes in this pr.
errors must be AgencyError with:
	•	Message includes the missing key name for missing fields
	•	Details include: path, key, expected, got (when applicable)

⸻

agency.json parsing rules
	•	file path is exactly: <repoRoot>/agency.json
	•	read uses os.ReadFile
	•	if file missing: E_NO_AGENCY_JSON
	•	if read error (e.g. permission denied): E_INVALID_AGENCY_JSON with cause
	•	json must parse as an object
	•	leading/trailing whitespace is allowed
	•	unknown keys are ignored
	•	schema versioning (v1): additive only; do not fail on unknown keys

required subset for this pr:
	•	version (int) must equal 1 (strict integer literal)
	•	defaults object must exist with non-empty:
	•	parent_branch (string)
	•	runner (string)
	•	scripts object must exist with non-empty:
	•	setup (string)
	•	runners values must be non-empty strings when present

optional in this pr:
	•	scripts.verify, scripts.archive (ignored)
	•	runners object mapping runner name → command string

json key mapping (must be exact):
	•	defaults.parent_branch ↔ Defaults.ParentBranch (json:"parent_branch")
	•	defaults.runner ↔ Defaults.Runner (json:"runner")
	•	scripts.setup ↔ Scripts.Setup (json:"setup")

⸻

tests

unit tests (required)

create table-driven unit tests using json fixtures (inline strings or files under testdata/):
	1.	valid config with runners override resolves

	•	expects RunnerCmd from runners.<name>

	2.	valid config without runners override uses builtin

	•	expects "claude" / "codex"

	3.	invalid version

	•	expects E_INVALID_AGENCY_JSON

	4.	missing required keys

	•	expects E_INVALID_AGENCY_JSON

	5.	runner not configured

	•	expects E_RUNNER_NOT_CONFIGURED

	6.	bad types

	•	e.g. runners: [], runners: {"claude": 123}, scripts.setup: false
	•	expects E_INVALID_AGENCY_JSON

	7.	json not an object

	•	agency.json is [] or "string"
	•	expects E_INVALID_AGENCY_JSON

	8.	missing required objects

	•	defaults missing entirely, scripts missing entirely
	•	expects E_INVALID_AGENCY_JSON with missing key details

	9.	runners value empty string

	•	runners: {"claude": ""}
	•	expects E_INVALID_AGENCY_JSON

notes:
	•	tests must not call git, tmux, or gh
	•	tests must not write files except temp dirs if needed

⸻

guardrails
	•	read-only: do not write/modify any files
	•	no script execution
	•	no git commands; repoRoot is provided by caller
	•	no new third-party deps
	•	do not validate verify/archive as required (slice 01 only needs setup)
	•	do not add config override mechanisms

⸻

definition of done
	•	LoadAgencyConfig returns correct resolved RunnerCmd and SetupScript
	•	correct error codes for all failure cases
	•	go test ./... passes
	•	no additional persistent state or behaviors introduced
