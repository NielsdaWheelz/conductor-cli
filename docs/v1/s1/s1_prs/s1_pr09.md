# agency slice 01 — pr-09: wire `agency run` end-to-end + `--attach` UX + output (v1 mvp)

## goal

ship the full S1 user flow: implement the `agency run` CLI command that executes the S1 pipeline end-to-end (repo gates → config → worktree → meta → setup → tmux), and provide the exact user-facing output + `--attach` behavior promised by the slice spec.

---

## scope

### in-scope

#### A) `agency run` CLI command

Implement:

- `agency run [--title <string>] [--runner <claude|codex>] [--parent <branch>] [--attach]`

Behavior:
- parse flags
- resolve repo root + repo_id from CWD
- load and validate `agency.json`
- default values:
  - if `--title` omitted: pass empty title; pipeline sets `untitled-<shortid>` after generating run_id
  - `--runner` default: `agency.json defaults.runner`
  - `--parent` default: `agency.json defaults.parent_branch`
- run the already-implemented internal pipeline:
  - must use the pipeline object from pr-04 (e.g. `NewPipeline(...).Run(...)`)
  - must preserve step ordering and short-circuit semantics already defined
- on success:
  - print a concise summary and next steps (exact format below)
- on failure:
  - print a single-line error summary including the error code and actionable hint(s)
  - print key evidence paths when available (worktree path, setup log path)
  - exit non-zero

#### B) `--attach` semantics

- when `--attach` is set:
  - after a successful pipeline run (tmux session exists), attach to the tmux session:
    - `tmux attach -t agency:<run_id>`
  - command blocks until user detaches/exits tmux client
  - after detach, exit code must be 0 (unless attach itself failed)
  - if tmux attach fails: return `E_TMUX_ATTACH_FAILED`

**note:** v1 does not attempt `switch-client`; `tmux attach` is used universally.

#### C) Output contract (human-facing)

On success (no `--attach`):
- print (stdout) the following lines (order fixed), using values returned by the pipeline result:

1. `run_id: <run_id>`
2. `title: <title>`
3. `runner: <runner_name>` (runner name, not runner_cmd)
4. `parent: <parent_branch>`
5. `branch: <branch>`
6. `worktree: <worktree_path>`
7. `tmux: <tmux_session_name>`
8. `next: agency attach <run_id>`

Additionally, if `.agency/` ignore check warned, include a warning line (stderr) after the summary:
- `warning: .agency/ is not ignored; run 'agency init' to add it to .gitignore`

On failure:
- print (stderr):
  - `error: <CODE>: <message>`
- if failure occurs after worktree creation (meta exists), also print:
  - `run_id: <run_id>`
  - `worktree: <worktree_path>`
- if setup started (log created), also print:
  - `setup_log: <absolute_path_to_setup.log>`
- exit non-zero.

### out-of-scope

- no `agency ls` (slice 2)
- no `resume/stop/kill/clean/show/mark`
- no github/PR functionality
- no transcript capture
- no changes to schemas beyond what earlier PRs added

---

## public surface area

### commands

- `agency run ...` (implemented / shipped in this PR)

### flags

- `--title`, `--runner`, `--parent`, `--attach` per slice spec

(no new flags)

---

## error handling rules (CLI)

- all internal errors must be surfaced as `AgencyError` with:
  - stable `Code` (string)
  - human message
  - optional details map (printed only when helpful and known-safe)

add to public error codes if missing:
- `E_TMUX_ATTACH_FAILED` — tmux attach returned non-zero

CLI printing rules:
- always print `error: <CODE>: <message>` to stderr
- do not print stack traces
- if details include paths (worktree/log), print those as additional lines
- exit codes:
  - 0 on success
  - non-zero on any error

---

## behaviors (given / when / then)

### 1) successful run, detached default

**given**
- repo gates succeed (clean parent, non-empty repo, local parent branch exists)
- `agency.json` valid
- worktree creation succeeds
- setup succeeds
- tmux session created

**when**
- user runs: `agency run --title "test run" --runner claude`

**then**
- exit 0
- stdout includes the success summary lines (exact keys, fixed order)
- tmux session exists: `tmux has-session -t agency:<run_id>` succeeds
- meta.json exists and includes:
  - required fields
  - `tmux_session_name` present

### 2) successful run with immediate attach

**when**
- user runs: `agency run --attach`

**then**
- pipeline runs to completion
- after completion, agency attaches to `agency:<run_id>` and blocks until detach
- after detach, agency exits 0
 - if attach fails, return `E_TMUX_ATTACH_FAILED`

### 3) dirty parent working tree

**given**
- `git status --porcelain` non-empty in repo root checkout

**when**
- `agency run`

**then**
- exit non-zero with `E_PARENT_DIRTY`
- no worktree/tmux/run dir created

### 4) setup fails

**given**
- worktree created
- setup returns non-zero or times out

**when**
- `agency run`

**then**
- exit non-zero with `E_SCRIPT_FAILED` or `E_SCRIPT_TIMEOUT`
- meta.json exists with `flags.setup_failed=true`
- tmux session does not exist
- stderr includes `setup_log: <.../logs/setup.log>`

### 5) tmux fails after setup success

**given**
- setup succeeded
- tmux creation fails

**when**
- `agency run`

**then**
- exit non-zero with `E_TMUX_FAILED` or `E_TMUX_SESSION_EXISTS`
- meta.json exists with `flags.tmux_failed=true`
- `tmux_session_name` absent

---

## tests

### manual smoke (required)

Use the slice spec’s manual smoke, updated to exercise `agency run`:

1) create tiny repo with a committed clean state and a local parent branch (default `main` or per agency.json).
2) create `agency.json`:
- `scripts.setup` prints and exits 0
- runner command exists; for smoke, set `runners.claude` to `sh` or another trivial command

3) run:
```bash
agency run --title "s1 smoke" --runner claude
tmux has-session -t agency:<run_id>
agency attach <run_id>   # confirm attach works, then detach

	4.	dirty parent:

echo x >> README.md
agency run
# must fail E_PARENT_DIRTY

automated (required)
- unit tests for CLI flag parsing defaults (table-driven):
  - no flags uses agency.json defaults
  - --parent overrides default
  - --runner overrides default
  - --title sets title
  - when title omitted, CLI passes empty title (pipeline sets default)
- unit tests for output formatting:
  - run command handler with fake pipeline result and assert stdout lines match exact order/keys
- integration test (recommended; may be behind tag integration):
  - temp repo + valid agency.json
  - run agency run (as a function call, not spawning a subprocess, if you have a command handler)
  - assert:
    - meta.json exists
    - tmux has-session succeeds
  - ensure test cleanup kills the tmux session (best-effort tmux kill-session -t agency:<run_id>) to avoid leaking sessions

⸻

guardrails
	•	do not introduce new commands beyond run
	•	do not implement ls, resume, stop, kill, clean, github ops
	•	do not add third-party deps
	•	do not change any directory layout or file schemas beyond what earlier PRs defined
	•	do not add background daemons or goroutines that outlive the command
	•	do not modify .gitignore or .git/info/exclude
	•	do not attempt attach unless pipeline succeeded and tmux_session_name is present

⸻

definition of done
	•	go test ./... passes
	•	agency run produces the exact success/failure output formats specified
	•	--attach attaches to tmux session after successful run and returns 0 after detach
	•	failure cases preserve correct on-disk evidence (meta.json, setup.log) and do not start tmux unless setup succeeded

⸻

claude prompt pack (implementation)

from repo root:
	1.	run tests

go test ./...

	2.	implement pr-09 exactly:

	•	implement agency run command using existing pipeline function and components from prior PRs
	•	add flag parsing and default behavior
	•	implement output formatting (fixed keys + order)
	•	implement --attach behavior using tmux attach -t agency:<run_id> only after pipeline success
	•	ensure error printing includes error code + evidence paths when available

	3.	run tests again

go test ./...

constraints:
	•	no extra flags or commands.
	•	no github functionality.
	•	keep output stable; do not add extra decorative text beyond what the spec requires.
