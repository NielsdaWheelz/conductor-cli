# agency slice 01 ‚Äî pr-01 spec: core utilities + errors + subprocess + atomic json

## goal
add the smallest reusable ‚Äúcore‚Äù layer needed by later s1 prs: run ids, slug/branch helpers, structured errors, subprocess runner, and atomic json writes.

## scope

### in-scope
- add a dedicated internal package for s1 core helpers (recommend: `internal/core`)
- implement:
  - run id generation
  - title slugify + branch name builder
  - posix-ish shell escaping for paths (for later tmux runner command construction)
  - runner shell-script builder (script string only; later code passes it to `sh -lc <script>`)
  - `AgencyError` (code/message/cause/details) + helpers
  - ensure `E_INTERNAL` exists in the l0 error list (add if missing)
  - subprocess helper `RunCmd(...)` with cwd/env/stdin-null/timeout
  - atomic json write helper (temp + rename, best-effort fsync)
- add unit tests for the above

### out-of-scope (hard)
- no git worktrees, no tmux, no script execution (besides generic subprocess helper), no cli commands/flags
- no new persistent schemas; do not write repo.json/meta.json yet
- no new deps (stdlib only)
- no ‚Äúpipeline‚Äù or orchestration scaffolding

---

## public surface area
none (no new commands/flags; internal packages only).

---

## files to create/modify

### create
- `internal/core/runid.go`
- `internal/core/slug.go`
- `internal/core/branch.go`
- `internal/core/shell.go`
- `internal/core/error.go`
- `internal/core/subprocess.go`
- `internal/core/atomicjson.go`
- `internal/core/*_test.go` (tests)

### modify
- none expected outside `internal/core/` for this PR

guardrail: if you think you need to touch `cmd/agency` or any s0 code, stop. this pr is pure utilities (go.mod may be updated only if required to wire internal/core).

---

## required function signatures (exact)

### run ids
```go
package core

// NewRunID returns "<yyyymmddhhmmss>-<rand4>" in UTC time.
// example: "20260109013207-a3f2"
// error only if crypto/rand read fails.
func NewRunID(now time.Time) (string, error)

// ShortID returns the 4-char random suffix (after the last '-').
// if the format is unexpected, return "xxxx".
func ShortID(runID string) string

notes:
	‚Ä¢	rand4 is 4 lowercase hex chars derived from crypto/rand (2 bytes).
	‚Ä¢	now is provided by caller for testability; use now.UTC() for formatting.

slug + branch

package core

// Slugify converts a title into a lowercase hyphen slug.
// - allowed: [a-z0-9-]
// - whitespace/underscore => hyphen
// - drop all other chars
// - collapse multiple hyphens
// - trim leading/trailing hyphens
// - maxLen enforced (truncate after cleanup)
// - after truncation, re-trim leading/trailing hyphens and collapse repeats
// if result empty or maxLen <= 0 => "untitled"
func Slugify(title string, maxLen int) string

// BranchName returns "agency/<slug>-<shortid>".
// slug max len must be 30 (call Slugify(title, 30)).
func BranchName(title, runID string) string

shell escaping + runner script builder

package core

// ShellEscapePosix returns a single shell token using single-quote strategy,
// including surrounding single quotes.
// example: abc -> 'abc'
// example: a'b -> 'a'"'"'b'
// example: "" -> ''
func ShellEscapePosix(s string) string

// BuildRunnerShellScript returns the shell *script* string to pass as argv to `sh -lc`.
// it must:
// - cd into worktreePath safely (using ShellEscapePosix)
// - then exec runnerCmd verbatim (runnerCmd is a shell snippet; user responsibility)
// example output:
//   "cd '...path...' && exec <runnerCmd>"
// note: runnerCmd is not trimmed or validated; empty is allowed here.
func BuildRunnerShellScript(worktreePath, runnerCmd string) string

important: this function returns the script, not "sh -lc '...'". later tmux code should execute:
	‚Ä¢	sh -lc <script> by passing args directly (no outer shell quoting).

structured errors

package core

type AgencyError struct {
	Code    string            // stable error code, e.g. "E_PARENT_DIRTY"
	Message string            // short human message
	Cause   error             // underlying error (optional)
	Details map[string]string // small structured context (optional)
}

func (e *AgencyError) Error() string
func (e *AgencyError) Unwrap() error

// NewError creates an AgencyError with no cause.
func NewError(code, message string, details map[string]string) *AgencyError

// WrapError wraps a cause into an AgencyError.
func WrapError(code, message string, cause error, details map[string]string) *AgencyError

// AsAgencyError returns (*AgencyError, true) if err is or wraps an AgencyError.
func AsAgencyError(err error) (*AgencyError, bool)

printing policy (for later cli prs; implement now as helpers):
	‚Ä¢	Error() should include code + message, not dump details/cause by default.
	‚Ä¢	format exactly: "<Code>: <Message>"
	‚Ä¢	details/cause are for structured handling/logging later.
	‚Ä¢	NewError/WrapError must defensively copy Details (or nil if empty).

subprocess helper

package core

type CmdOpts struct {
	Cwd     string            // "" = inherit
	EnvAdd  map[string]string // added/overridden env vars (nil ok)
	Timeout time.Duration     // 0 = no additional timeout beyond ctx
}

type CmdResult struct {
	Stdout   string
	Stderr   string
	ExitCode int // 0 for success; non-zero for process exit; 124 for timeout-kill (see below)
}

func RunCmd(ctx context.Context, name string, args []string, opts CmdOpts) (CmdResult, error)

requirements:
	‚Ä¢	uses exec.CommandContext
	‚Ä¢	if opts.Timeout > 0: derive ctx2, cancel := context.WithTimeout(ctx, opts.Timeout)
	‚Ä¢	stdin is always nil or strings.NewReader("")? no. must be /dev/null equivalent:
	‚Ä¢	set cmd.Stdin = nil (go stdlib reads from os.DevNull)
	‚Ä¢	do not inherit terminal stdin
	‚Ä¢	capture stdout/stderr buffers (strings ok)
	‚Ä¢	env behavior:
	‚Ä¢	start from os.Environ()
	‚Ä¢	apply EnvAdd overrides/additions
	‚Ä¢	exit code rules:
	‚Ä¢	if process exits with code N: return ExitCode=N, err=nil
	‚Ä¢	if command failed to start: return err != nil (wrap later), ExitCode=-1
	‚Ä¢	if context deadline exceeded: return ExitCode=124, err=nil (so callers can map to E_SCRIPT_TIMEOUT)
	‚Ä¢	if context canceled: return ExitCode=125, err=context.Canceled
	‚Ä¢	still include whatever stdout/stderr captured

atomic json writer

package core

// WriteJSONAtomic writes v as pretty json (2-space indent) to path atomically.
// - create temp file in same dir
// - write bytes
// - best-effort file.Sync()
// - close
// - chmod(perm) best-effort before rename
// - rename over target
// - best-effort fsync dir (ok to skip on platforms where it‚Äôs painful)
// perm is applied on create (e.g. 0o644).
// parent dir must exist; do not mkdir here.
func WriteJSONAtomic(path string, v any, perm fs.FileMode) error


‚∏ª

behavior (given/when/then)

run id format

given: now = 2026-01-09T01:32:07Z
when: NewRunID(now)
then:
	‚Ä¢	matches regex ^\d{14}-[0-9a-f]{4}$
	‚Ä¢	timestamp portion equals 20260109013207
	‚Ä¢	rand suffix is lowercase hex

slugify

given: "  Hello, World!!  "
when: Slugify(title, 30)
then: "hello-world"

given: "---___---"
then: "untitled"

given: "a  b   c"
then: "a-b-c"

given: "a__b__c"
then: "a-b-c"

given: "aü•¥b"
then: "ab"

truncate rule:
given: "abcdefghijklmnopqrstuvwxyz0123456789" (len>30)
then: length <= 30 and still matches ^[a-z0-9]+(-[a-z0-9]+)*$ or "untitled"

maxLen rule:
given: maxLen <= 0
then: "untitled"

branch name

given: title "Test Run", runID 20260109013207-a3f2
when: BranchName(title, runID)
then: agency/test-run-a3f2

shell escape

given: abc
then: 'abc'

given: a'b
then: 'a'"'"'b'

given: ""
then: ''

given: "a\nb"
then: 'a
b'

build runner script

given: worktreePath /tmp/a b, runnerCmd claude --foo
then: cd '/tmp/a b' && exec claude --foo

(note: runnerCmd is inserted verbatim; this is intentional.)

RunCmd timeout exit code

given: command sleeps longer than opts.Timeout
when: RunCmd(ctx, ‚Äúsh‚Äù, []string{‚Äù-lc‚Äù, ‚Äúsleep 10‚Äù}, Timeout=50ms)
then:
	‚Ä¢	result.ExitCode == 124
	‚Ä¢	err == nil

RunCmd cancel exit code

given: ctx canceled before process exits
when: RunCmd(ctx, ‚Äúsh‚Äù, []string{‚Äù-lc‚Äù, ‚Äúsleep 10‚Äù}, Timeout=0)
then:
	‚Ä¢	result.ExitCode == 125
	‚Ä¢	err == context.Canceled

RunCmd start failure

given: command name does not exist
when: RunCmd(ctx, ‚Äúno_such_cmd‚Äù, nil, Timeout=0)
then:
	‚Ä¢	result.ExitCode == -1
	‚Ä¢	err != nil

‚∏ª

tests (must add)

unit tests (required)
	‚Ä¢	TestNewRunID_FormatAndUTC
	‚Ä¢	TestShortID
	‚Ä¢	TestSlugify_Table
	‚Ä¢	TestSlugify_TruncationDoesNotEndWithHyphen
	‚Ä¢	TestBranchName
	‚Ä¢	TestShellEscapePosix_Table
	‚Ä¢	TestShellEscapePosix_EmptyString
	‚Ä¢	TestShellEscapePosix_Newline
	‚Ä¢	TestBuildRunnerShellScript
	‚Ä¢	TestRunCmd_ExitCode
	‚Ä¢	TestRunCmd_TimeoutExit124
	‚Ä¢	TestRunCmd_CanceledExit125AndErrCanceled
	‚Ä¢	TestRunCmd_StartFailureExitMinus1AndErr
	‚Ä¢	TestWriteJSONAtomic_ReplacesAndIsValidJSON
	‚Ä¢	TestWriteJSONAtomic_PermApplied

tests must be deterministic:
	‚Ä¢	for run ids: pass fixed now; do not assert exact rand suffix, only format.
	‚Ä¢	for atomic write: write initial file, then overwrite with different json, ensure final file parses and equals new content.

commands to run
	‚Ä¢	go test ./...

‚∏ª

guardrails
	‚Ä¢	stdlib only. do not add cobra/viper/bubbletea/loggers.
	‚Ä¢	do not add any cli commands or flags.
	‚Ä¢	do not write any repo/global state files (repo.json/meta.json). only helpers.
	‚Ä¢	do not invent new error codes here (except E_INTERNAL if missing).
	‚Ä¢	do not add concurrency/locks.
	‚Ä¢	keep everything under internal/core (or equivalent single package). no spread.

‚∏ª

definition of done
	‚Ä¢	all new code is under internal/core/
	‚Ä¢	go test ./... passes
	‚Ä¢	no existing packages changed (except go.mod/go.sum if required)
	‚Ä¢	helpers match signatures + behaviors above exactly
	‚Ä¢	E_INTERNAL exists in the l0 error list
