# agency slice 01 — pr-04 spec: run pipeline orchestration (internal API)

## goal
introduce a stable internal integration seam for slice 01 by defining a
pipeline orchestrator that executes named steps in order, short-circuits on
first error, and preserves `AgencyError` codes—without implementing worktrees,
setup execution, tmux, or CLI wiring in this PR.

---

## scope

### in-scope
- define a pipeline struct and constructor (no globals):

```go
type Pipeline struct {
  steps []namedStep
}

func NewPipeline(steps []namedStep) *Pipeline
func (p *Pipeline) Run(ctx context.Context, opts RunPipelineOpts) (runID string, err error)
```

- define RunPipelineOpts containing only the inputs needed by slice 01:

```go
type RunPipelineOpts struct {
  Title  string // may be empty => later PR applies default
  Runner string // may be empty => later PR applies default from agency.json
  Parent string // may be empty => later PR applies default from agency.json
  Attach bool   // later PR uses this; pipeline stores it but does not attach here
}
```

- define a named step representation and pipeline step type:

```go
type pipelineStep func(ctx context.Context, st *pipelineState) error

type namedStep struct {
  Name string
  Fn   pipelineStep
}
```

- define the step ordering (exact names, part of test expectations):
  1) CheckRepoSafe
  2) LoadAgencyConfig
  3) CreateWorktree
  4) WriteMeta
  5) RunSetup
  6) StartTmux
- step names are identifiers; do not rename without updating tests

- define a single in-memory pipelineState struct in internal/pipeline that
  accumulates:
  - RepoRoot, RepoID, OriginURL
  - ResolvedRunnerCmd, SetupScript
  - run_id, title, branch, worktree_path, runner_cmd, parent_branch

- pipeline behavior:
  - generate run_id immediately (from PR-01 helper) and store in state
  - copy opts into state but do not normalize defaults in this PR
  - short-circuit on first error; no subsequent steps run
  - if error is *AgencyError, preserve code/message/details exactly
  - if error is not *AgencyError, wrap into *AgencyError with:
    - Code = E_INTERNAL
    - Message = "internal error"
    - Cause = original error
    - Details = map[string]string{"step": "<StepName>"}
  - Run must return runID even on error (after run_id generation)

- default wiring:
  - this PR does not provide default step wiring to real implementations
  - tests pass explicit steps into NewPipeline
  - the pipeline must not import or call PR-02/PR-03 functions directly

### out-of-scope
- no CLI commands or flag parsing
- no git worktree operations
- no script execution
- no tmux operations
- do not change PR-02 or PR-03 behavior beyond what is required to call them
- do not add persistence formats or write any files

---

## public surface area added/changed

internal api
- Pipeline, NewPipeline, (*Pipeline).Run, and supporting internal types in the
  pipeline package/module

no other exported APIs.

---

## error codes

this PR introduces one new error code:
- E_NOT_IMPLEMENTED — returned only by explicit stub steps used in tests
  - Message: "not implemented"
  - Details: map[string]string{"step":"<StepName>"}

also uses existing code:
- E_INTERNAL — for unexpected errors (must already exist from PR-01; if not, add
  it there, not here)

guardrail: do not introduce any additional error codes.

---

## behavioral contract (given/when/then)

1) short-circuit preserves error codes

given
- CheckRepoSafe returns AgencyError{Code: E_PARENT_DIRTY, ...}

when
- p.Run(ctx, opts) is called

then
- p.Run returns that error (code preserved)
- LoadAgencyConfig and later steps are not called
- p.Run returns runID even on error

---

2) success through implemented steps reaches first stub and returns not implemented

given
- CheckRepoSafe succeeds
- LoadAgencyConfig succeeds

when
- p.Run(ctx, opts) is called

then
- p.Run returns E_NOT_IMPLEMENTED with Details{"step":"CreateWorktree"} and
  Message "not implemented"
- WriteMeta, RunSetup, StartTmux are not called

---

3) non-agency errors are wrapped

given
- a step returns a non-AgencyError error (e.g. errors.New("boom"))

when
- p.Run(...)

then
- returned error is an AgencyError with:
  - code = E_INTERNAL
  - message = "internal error"
  - cause populated
  - details include step name under key "step"

---

## implementation requirements

minimal state derivation in this PR:
- Run must generate a run_id immediately and store it in state.
- Do not apply defaults for title/parent/runner in this PR; pipeline may carry
  empty strings.
- After LoadAgencyConfig, store:
  - state.ResolvedRunnerCmd = cfg.RunnerCmd
  - state.SetupScript = cfg.SetupScript

no file paths are computed here beyond what the called functions need.

---

## tests

unit tests (required)

write unit tests for RunPipeline using dependency injection to avoid invoking
git or filesystem.

required approach:
- NewPipeline accepts step functions directly (no package-level vars).
- Tests must not call real CheckRepoSafe or real LoadAgencyConfig.

test cases:
1) short-circuit on first step error
- first step returns AgencyError{Code: "E_PARENT_DIRTY"}
- assert subsequent steps not called
- assert returned code preserved

2) reaches CreateWorktree stub and returns E_NOT_IMPLEMENTED
- first two steps succeed
- third step is stub returning E_NOT_IMPLEMENTED with Details{"step":"CreateWorktree"}
- assert returned code and detail

3) wrap non-agency error into E_INTERNAL
- a step returns errors.New("boom")
- assert returned error is AgencyError with E_INTERNAL and includes the step name
  in details

guardrails for tests
- no integration tests in this PR
- no temp git repos
- no tmux

---

## guardrails
- keep it minimal: do not introduce frameworks or complex DI containers
- no new third-party dependencies
- no persistence
- no retry logic
- do not silently skip steps; step order is fixed
- do not ship placeholder steps in production wiring

---

## definition of done
- Pipeline exists, runs steps in fixed order, and short-circuits correctly
- stub steps used in tests return E_NOT_IMPLEMENTED with step name detail
- unit tests cover the three required behaviors
- go test ./... passes
