# agency slice 00 / pr-04: `agency init` (scaffold + gitignore)

## goal
implement `agency init [--no-gitignore] [--force]` exactly per slice-00 spec: scaffold `agency.json`, create required stub scripts (if missing), and ensure `.agency/` is ignored (by default).

this PR must be narrowly scoped to **init only**.

---

## scope

### in scope
- add the `agency init` command implementation + wiring
- repo discovery via `git rev-parse --show-toplevel` (reuse existing repo discovery code)
- create `agency.json` template (version 1) at repo root
- create `scripts/` dir if missing
- create stub scripts if missing (never overwrite); set mode `0755`
- `.gitignore` append behavior:
  - by default append `.agency/`
  - create `.gitignore` if missing
  - no duplicate `.agency/` entries
  - ensure file ends with newline
  - `--no-gitignore` skips all `.gitignore` modifications
- overwrite behavior:
  - if `agency.json` exists and `--force` is **not** set → fail `E_AGENCY_JSON_EXISTS`
  - if `--force` set → overwrite `agency.json` only; still never overwrite scripts

### explicitly out of scope
- `agency doctor` behavior changes
- any global persistence: no writes to `${AGENCY_DATA_DIR}` files
- any worktrees, tmux session creation, script execution
- any network calls
- any new config schema beyond `agency.json` template written by init

---

## public surface area

### command
- `agency init [--no-gitignore] [--force]`

### flags
- `--no-gitignore` (bool, default false): do not modify `.gitignore`
- `--force` (bool, default false): overwrite existing `agency.json`

### error codes used
- `E_NO_REPO` — not in a git repo
- `E_AGENCY_JSON_EXISTS` — `agency.json` exists and `--force` not set
- `E_FS` / existing generic filesystem error wrapper (use your existing error pattern) for IO failures

(no new error codes in this PR.)

---

## required behavior

### repo discovery
- find repo root via your existing helper (which shells out to `git rev-parse --show-toplevel`)
- if not in repo: return `E_NO_REPO` with actionable message (“run inside a git repo”)

### write `agency.json` template
- path: `<repo_root>/agency.json`
- template content MUST match L0 exactly:

```json
{
  "version": 1,
  "defaults": {
    "parent_branch": "main",
    "runner": "claude"
  },
  "scripts": {
    "setup": "./scripts/agency_setup.sh",
    "verify": "./scripts/agency_verify.sh",
    "archive": "./scripts/agency_archive.sh"
  },
  "runners": {
    "claude": "claude",
    "codex": "codex"
  }
}

rules:
	•	if agency.json exists and --force is false: error E_AGENCY_JSON_EXISTS
	•	if --force true: overwrite agency.json (atomic write preferred if available, but not strictly required for local file in v1; if you already have writeFileAtomic, use it)

create stub scripts (never overwrite)
	•	ensure <repo_root>/scripts/ exists (mkdir -p)
	•	for each path below, if missing: create with mode 0755 (chmod after write is fine)

paths:
	•	scripts/agency_setup.sh
	•	scripts/agency_verify.sh
	•	scripts/agency_archive.sh

contents (exact requirements):

setup/archive
	•	starts with shebang: #!/usr/bin/env bash
	•	includes set -euo pipefail
	•	includes a comment indicating stub
	•	exits 0

example (allowed to differ only in comment text):

#!/usr/bin/env bash
set -euo pipefail
# agency stub: replace with repo-specific setup steps (deps/env/etc)
exit 0

verify
	•	starts with shebang: #!/usr/bin/env bash
	•	includes set -euo pipefail
	•	includes a comment indicating stub and must be replaced
	•	prints a message: replace scripts/agency_verify.sh
	•	exits 1

example:

#!/usr/bin/env bash
set -euo pipefail
# agency stub: replace with repo-specific verification (tests/lint/etc)
echo "replace scripts/agency_verify.sh"
exit 1

overwrite rules:
	•	never overwrite existing scripts (even with --force)
	•	if scripts exist, leave untouched

.gitignore behavior
	•	unless --no-gitignore:
	•	target: <repo_root>/.gitignore
	•	if missing: create it
	•	ensure .agency/ is present as its own line
	•	do not add duplicate entries:
	•	treat any existing line equal to .agency/ as present (exact match)
	•	do not attempt fancy normalization (v1)
	•	ensure final file ends with newline \n after modifications
	•	if --no-gitignore set:
	•	do not read/write .gitignore
	•	print a warning to stdout: user must ensure .agency/ is ignored

output

keep output stable and parseable (stdout):
	•	on success, print at least:
	•	repo_root: <path>
	•	wrote_agency_json: true|false (false only if it existed and –force not set, but in that case command fails; so in success it’s always true)
	•	created_scripts: <comma-separated list or 'none'>
	•	gitignore_updated: true|false

stderr:
	•	errors only, formatted using your standard error wrapper

exit codes:
	•	0 on success
	•	non-zero on failure with correct error code

⸻

files to create/modify

expected additions (adjust names to match your existing layout):
	•	internal/commands/init.go — command implementation
	•	internal/scaffold/agencyjson_template.go — template bytes or builder
	•	internal/scaffold/stubs.go — stub script creation helpers
	•	internal/scaffold/gitignore.go — append helper
	•	internal/cli/dispatch.go (or equivalent) — wire init subcommand to handler + flags + help text

avoid touching unrelated modules.

⸻

tests

automated (required)

integration-style tests using a temp directory:
	1.	init creates config and stubs

	•	given: temp git repo with no agency.json and no scripts/
	•	when: run init handler
	•	then:
	•	agency.json exists and equals the exact template (byte-for-byte is fine)
	•	scripts exist with executable bit
	•	.gitignore exists and contains .agency/ once
	•	.gitignore ends with newline

	2.	init refuses overwrite

	•	given: repo with existing agency.json
	•	when: init without --force
	•	then: returns E_AGENCY_JSON_EXISTS and does not modify existing file

	3.	init overwrites agency.json with –force, but not scripts

	•	given: repo with existing agency.json (custom content) and existing stub scripts (custom content)
	•	when: init with --force
	•	then:
	•	agency.json replaced with template
	•	scripts unchanged

	4.	gitignore idempotent

	•	given: .gitignore already contains .agency/
	•	when: init
	•	then: .agency/ still appears exactly once and file ends with newline

	5.	–no-gitignore

	•	given: repo with no .gitignore
	•	when: init --no-gitignore
	•	then: .gitignore not created/modified

notes:
	•	tests may call the init handler directly with stubbed CommandRunner returning repo root for git rev-parse.
	•	use real filesystem (temp dirs) rather than a fake FS unless you already have a robust fake.

manual (optional but recommended)
	•	run agency init in a real repo and confirm files + modes look correct

⸻

guardrails
	•	do not create or modify anything under ${AGENCY_DATA_DIR}
	•	do not implement doctor logic or touch doctor code
	•	do not execute scripts
	•	do not add new error codes (except if absolutely necessary; if you do, also update l0 in this PR—prefer not)
	•	keep init safe to run anytime; must not require clean working tree

⸻

how to run
	•	go test ./...
	•	(optional) agency init inside a test repo

⸻

claude prompt pack (for implementation)

you are implementing slice 00 pr-04 only: agency init.

constraints:
	•	implement agency init [--no-gitignore] [--force] exactly as specified.
	•	do not touch doctor beyond wiring help text if necessary.
	•	no ${AGENCY_DATA_DIR} writes.
	•	no worktree/tmux/session logic.
	•	keep output stable key/value lines on stdout.
	•	add the tests listed; keep them deterministic.

commands:
	•	go test ./...

deliverables:
	•	working agency init
	•	tests passing
	•	no scope creep
