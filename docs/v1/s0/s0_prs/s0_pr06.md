# agency slice 00 / pr-06: close slice 00 (docs + contract sync + polish)

## goal
finish slice 00 by locking public contracts in docs and ensuring the CLI/err taxonomy is consistent and reviewable:
- docs reflect the actual implemented behavior for init/doctor
- error codes list is complete and aligned with code
- persistence schemas are documented with examples
- help text and exit behavior are consistent
- no new features

this PR is **docs-first** with only minimal code tweaks required to align behavior with the documented contract.

---

## scope

### in scope
- update `docs/v1/constitution.md` to match v1 slice-00 reality
- add slice doc: `docs/v1/slices/slice-00_bootstrap.md`
- ensure error code list in l0 includes all codes used by slice-00
- document:
  - `agency.json` schema v1 (fields + rules)
  - `repo_index.json` schema v1 (fields + merge behavior)
  - `repo.json` schema v1 (fields + created_at/updated_at semantics)
  - `agency init` behavior (flags, stub scripts, .gitignore behavior)
  - `agency doctor` output keys (exact list + semantics)
- small code polish only if needed:
  - CLI `--help` text matches command/flag behavior
  - error printing is stable (code + message + optional hint)
  - ensure stdout on failure is empty (doctor), stderr contains error
  - ensure `agency init` / `doctor` exit codes are non-zero on failure

### explicitly out of scope
- adding new commands or flags
- changing persistence formats (unless required to match already-implemented behavior; if code differs from docs, prefer updating docs, not changing code)
- adding locks, worktrees, tmux sessions, script execution, runs/meta/events

---

## public surface area (docs only)
- `docs/v1/constitution.md` updated
- new: `docs/v1/slices/slice-00_bootstrap.md`

(no new runtime surfaces)

---

## required doc updates

### 1) update l0 error codes section
ensure l0 includes slice-00 codes actually used:
- `E_NO_REPO`
- `E_NO_AGENCY_JSON`
- `E_INVALID_AGENCY_JSON`
- `E_AGENCY_JSON_EXISTS`
- `E_GIT_NOT_INSTALLED`
- `E_TMUX_NOT_INSTALLED`
- `E_GH_NOT_INSTALLED`
- `E_GH_NOT_AUTHENTICATED`
- `E_RUNNER_NOT_CONFIGURED`
- `E_SCRIPT_NOT_FOUND`
- `E_SCRIPT_NOT_EXECUTABLE`
- `E_PERSIST_FAILED`
- `E_INTERNAL`

use a single generic public code:
- `E_INTERNAL` — unexpected IO/exec failures or bugs after validation passed

### 2) document `repo_index.json` schema with example
add a concise schema section + one example file.

must include:
- `schema_version`
- `repos` mapping
- per-entry fields:
  - `repo_id`
  - `paths`
  - `last_seen_at`

example should show at least one `github:` and one `path:` repo_key.

### 3) document `repo.json` schema with example
must include:
- identity: `repo_key`, `repo_id`
- paths: `repo_root_last_seen`, `agency_json_path`
- origin fields: `origin_present`, `origin_url`, `origin_host`, `capabilities` (github_origin, origin_host, gh_authed)
- timestamps: `created_at`, `updated_at` (created_at set once)

### 4) document `agency doctor` stdout contract
list the exact keys in order (matching implementation):
- repo_root, agency_data_dir, agency_config_dir, agency_cache_dir
- repo_key, repo_id, origin_present, origin_url, origin_host, github_flow_available
- git_version, tmux_version, gh_version, gh_authenticated
- defaults_parent_branch, defaults_runner, runner_cmd, script_setup, script_verify, script_archive
- status

note: do not promise JSON output in v1.
rule: always print every key in this order; unknown values are empty strings; booleans are true|false. format is `key: value` with a single space after colon.

failure output contract:
- on any doctor failure: stdout is empty
- stderr prints `error_code: E_...` then a message line; optional `hint:` line
- exit code is non-zero

### 5) document `agency init`
- flags: `--no-gitignore`, `--force`
- overwrite semantics
- `.gitignore` append rules
- stub scripts: paths + minimal contents + executable bit
- clarify verify stub exits 1 intentionally
- require `agency.json` to be written via atomic rename

---

## files to create/modify

### docs
- `docs/v1/constitution.md` (update)
- `docs/v1/slices/slice-00_bootstrap.md` (new)

### code (only if needed)
potentially:
- `internal/cli/dispatch.go` help text consistency
- error formatting utilities (only if mismatch with docs)

keep code diffs minimal.

---

## acceptance criteria (observable)

1) docs reflect reality
- running `agency init --help` and `agency doctor --help` matches docs
- docs contain complete error code list used by slice-00

2) slice-00 demo works
```bash
cd <repo>
agency init
agency doctor

```

3) tests still pass

```bash
go test ./...
```

⸻

tests

no new test requirements beyond keeping go test ./... green.
(if you must tweak output/error formatting, update golden tests accordingly.)

⸻

guardrails
	•	do not change persistence schemas unless absolutely required to match already-merged PRs
	•	do not add new features/flags/commands
	•	do not touch worktree/tmux/session logic
	•	keep docs concise; avoid duplicating the entire constitution inside slice doc—link to l0 where possible
	•	help text should only change when it contradicts actual flags/behavior

⸻

claude prompt pack (for implementation)

you are implementing slice 00 pr-06 only: docs + contract sync.

constraints:
	•	docs-first: update docs/v1/constitution.md and add docs/v1/slices/slice-00_bootstrap.md
	•	ensure error codes listed match actual slice-00 behavior
	•	do not add new features or broaden scope
	•	only minimal code changes permitted to align CLI help/error formatting with documented contract
	•	use existing on-disk schema produced by pr-03 as source of truth; do not change it in pr-06

schema versioning:
	•	`schema_version` is a string in v1 (e.g. "1.0")

commands:
	•	go test ./...

deliverables:
	•	updated l0 doc
	•	new slice-00 doc
	•	tests pass
