# agency l0: constitution (v1 mvp)

local-first runner manager: creates isolated git workspaces, launches `claude`/`codex` TUIs in tmux, opens github PRs via `gh`.

---

## 1) purpose

agency makes "spin up an ai coding session on a clean branch" trivial, inspectable, and reversible.

core loop:
1. create workspace from parent branch (requires clean working tree)
2. run `claude` or `codex` in tmux session
3. push branch + create PR (`agency push`)
4. user reviews via PR or locally
5. user confirms merge
6. agency merges via `gh pr merge` and archives

---

## 2) non-goals (v1)

- no planner/council mode
- no headless automation
- no sandboxing/containers
- no cross-host orchestration
- no multi-repo intelligence
- no transcript replay on resume
- no auto-update / self-update

---

## 3) primitives

**repo**: local git checkout with `origin` remote pointing to github.

**repo identity**:
- primary: `github:<owner>/<repo>` (parsed from `git remote get-url origin`)
- fallback: `path:<sha256(abs_path)>` (for non-github remotes)
- stored in `${AGENCY_DATA_DIR}/repo_index.json` mapping repo_key → seen paths

**workspace (run)**: git worktree + branch + tmux session + metadata. survives multiple invocations.

**run_id**: `<timestamp>-<random>` (e.g., `20250109-a3f2`)

**invocation**: one execution of runner in workspace. may exit; workspace persists. relaunch via `resume`.

**runner**: `claude` or `codex` (must be on PATH, or specify command in agency.json).

---

## 4) hard constraints

- implementation: **Go**
- github integration: **`gh` CLI** only
- attach/detach: **tmux** only
- isolation: **git worktrees**
- config: **`agency.json`** required at repo root
- scripts: **setup/verify/archive** required
- merge: **human confirmation** required

---

## 5) packaging and distribution

**supported install methods (v1)**:
- dev install: `go install github.com/anthropics/agency@latest`
- releases: github releases with prebuilt binaries (darwin-amd64, darwin-arm64, linux-amd64)
- homebrew: `brew install anthropics/tap/agency`

**not supported (v1)**:
- auto-update / self-update
- linux distro packages (apt/yum/pacman)

---

## 6) prerequisites

agency requires (checked via `agency doctor`):
- `git`
- `gh` (authenticated: `gh auth status`)
- `tmux`
- configured runner (`claude` or `codex` on PATH, or custom command)

`agency doctor` also prints resolved directory paths (data, config, cache).

---

## 7) directories

### xdg-based resolution

**data directory** (`AGENCY_DATA_DIR`):
1. if `$AGENCY_DATA_DIR` set: use it
2. else if `$XDG_DATA_HOME` set: `$XDG_DATA_HOME/agency`
3. else: `~/.local/share/agency`

**config directory** (reserved, unused in v1):
1. if `$XDG_CONFIG_HOME` set: `$XDG_CONFIG_HOME/agency`
2. else: `~/.config/agency`

**cache directory** (reserved, unused in v1):
1. if `$XDG_CACHE_HOME` set: `$XDG_CACHE_HOME/agency`
2. else: `~/.cache/agency`

all global state lives under `${AGENCY_DATA_DIR}`.

---

## 8) agency.json

**location**: must exist at repo root (`git rev-parse --show-toplevel`). no subdir or monorepo overrides in v1.

```json
{
  "version": 1,
  "defaults": {
    "parent_branch": "main",
    "runner": "claude"
  },
  "scripts": {
    "setup": "./scripts/agency_setup.sh",
    "verify": "./scripts/agency_verify.sh",
    "archive": "./scripts/agency_archive.sh"
  },
  "runners": {
    "claude": "claude",
    "codex": "codex"
  }
}
```

**required fields**:
- `defaults.parent_branch`
- `defaults.runner`
- `scripts.setup`, `scripts.verify`, `scripts.archive`

**runner resolution**:
- if `runners.<name>` exists: use that command
- else if `defaults.runner` is `claude` or `codex`: assume on PATH
- else: error `E_RUNNER_NOT_CONFIGURED`

---

## 9) scripts

**requirements**:
- non-interactive (stdin is `/dev/null`)
- idempotent
- run outside tmux (subprocess, not in runner pane)
- timeouts: setup 10m, verify 30m, archive 5m

**semantics**: exit 0 = pass, non-zero = fail. stdout/stderr logged.

**workspace directories** (created by agency before scripts run):
- `<worktree>/.agency/`
- `<worktree>/.agency/out/`
- `<worktree>/.agency/tmp/`

**environment** (injected by agency):
- `AGENCY_RUN_ID`
- `AGENCY_TITLE`
- `AGENCY_REPO_ROOT`
- `AGENCY_WORKSPACE_ROOT`
- `AGENCY_BRANCH`
- `AGENCY_PARENT_BRANCH`
- `AGENCY_ORIGIN_NAME` (usually `origin`)
- `AGENCY_ORIGIN_URL`
- `AGENCY_RUNNER` (e.g., `claude`)
- `AGENCY_PR_URL` (empty string if no PR)
- `AGENCY_PR_NUMBER` (empty string if no PR)
- `AGENCY_DOTAGENCY_DIR` — `<worktree>/.agency/`
- `AGENCY_OUTPUT_DIR` — `<worktree>/.agency/out/`
- `AGENCY_LOG_DIR` — `${AGENCY_DATA_DIR}/repos/<repo_id>/runs/<run_id>/logs/`
- `AGENCY_NONINTERACTIVE=1`
- `CI=1`

**structured outputs** (optional in v1):

scripts may write to `.agency/out/<script>.json`. if present, must follow schema:

```json
{
  "schema_version": "1.0",
  "ok": true,
  "summary": "one-line description",
  "data": {}
}
```

supported files:
- `.agency/out/setup.json`
- `.agency/out/verify.json`
- `.agency/out/archive.json`

if present, agency uses `ok` field; if absent, uses exit code only.

---

## 10) storage

### global (`${AGENCY_DATA_DIR}`)

```
${AGENCY_DATA_DIR}/
  repo_index.json         # repo_key -> [seen_paths]
  repos/<repo_id>/
    repo.json
    runs/<run_id>/
      meta.json           # run metadata (retained on archive)
      logs/               # script stdout/stderr
    worktrees/<run_id>/   # git worktree (deleted on archive)
```

`repo_id` = sha256(repo_key) truncated.

### workspace-local (`<worktree>/.agency/`)

- `.agency/report.md` — synced to PR body on push
- `.agency/out/` — script outputs
- `.agency/tmp/` — scratch space

### archived state

`agency clean` or post-merge archive:
- deletes worktree directory
- deletes tmux session (if exists)
- **retains** `${AGENCY_DATA_DIR}/repos/<repo_id>/runs/<run_id>/` (meta.json, logs/)

### retention

v1: archived metadata retained indefinitely. user can manually delete `${AGENCY_DATA_DIR}/repos/<repo_id>/runs/<run_id>/` to reclaim space. `agency gc` deferred to post-v1.

---

## 11) status model

status is **composable**, not a flat enum:

### lifecycle (mutually exclusive)
- `open` — workspace exists, not merged/abandoned
- `merged` — PR merged via gh
- `abandoned` — user explicitly abandoned

### runtime (for open runs only)
- `active` — tmux session `agency:<run_id>` exists
- `idle` — no tmux session

### flags (can be combined)
- `needs_attention` — verify failed OR PR not mergeable OR stop requested
- `setup_failed` — setup script exited non-zero

### display status

`agency ls` shows a single derived string for UX. check in order:
1. if `merged` → "merged"
2. if `abandoned` → "abandoned"
3. if `setup_failed` → "failed"
4. if worktree deleted → "archived"
5. if `needs_attention` → "needs attention"
6. if `active` and PR open and report exists and non-empty → "ready for review"
7. if `active` and PR open → "active (report missing)"
8. if `active` → "active"
9. if PR open → "idle (pr open)"
10. else → "idle"

### runner detection (v1)

`active` = tmux session exists. no pid inspection in v1.

---

## 12) git + github

**repo discovery**: `git rev-parse --show-toplevel` from cwd.

**branch naming**: `agency/<slug>-<shortid>`
- slug: sanitized title (lowercase, hyphens, max 30 chars)
- shortid: first 4 chars of run_id

**parent branch**: defaults to `agency.json defaults.parent_branch`. override with `--parent <branch>`.

**clean working tree**: `agency run` requires:
- cwd not inside existing agency worktree
- repo checkout has clean `git status --porcelain`

### push behavior

`agency push <id>`:
1. `git fetch <origin>` — ensures remote refs exist; does NOT rebase, reset, or modify local branches
2. check commits ahead: `git rev-list --count <parent_branch>..<workspace_branch> > 0`
3. `git push origin <workspace_branch>`
4. if no PR exists and commits ahead > 0: create PR via `gh pr create`
5. if `.agency/report.md` exists and non-empty: sync to PR body
6. store PR url/number in metadata

**merge behavior**:
1. check `gh pr view --json mergeable`
2. run `scripts.verify`, record result
3. if verify failed: prompt "continue anyway?" (skip with `--force`)
4. prompt for human confirmation
5. `gh pr merge`
6. archive workspace

if not mergeable: `E_PR_NOT_MERGEABLE`. no auto-rebase.

---

## 13) report

lives at `<worktree>/.agency/report.md`.

template:

```markdown
# <title>

## summary
- what changed (high level)
- why (intent)

## scope
- completed
- explicitly not done / deferred

## decisions
- important choices + rationale
- tradeoffs

## deviations
- where it diverged from spec + why

## problems encountered
- failing tests, tricky bugs, constraints

## how to test
- exact commands
- expected output

## review notes
- files deserving scrutiny
- potential risks

## follow-ups
- blockers or questions
```

**push validation**: `agency push` warns if `.agency/report.md` is missing or effectively empty. use `--force` to push anyway.

---

## 14) commands

```
agency init                       create agency.json template
agency run [--title] [--runner] [--parent]
                                  create workspace, setup, start tmux
agency ls                         list runs + statuses
agency show <id> [--path]         show run details
agency attach <id>                attach to tmux session
agency resume <id> [--detached]   ensure runner running, attach
agency stop <id>                  send C-c to runner (best-effort)
agency kill <id>                  kill tmux session
agency push <id> [--force]        push + create/update PR
agency merge <id> [--force]       verify, confirm, merge, archive
agency clean <id>                 archive without merging
agency doctor                     check prerequisites + show paths
```

### resume semantics

`agency resume <id>`:
1. if tmux session missing: create `agency:<run_id>` with cwd = worktree
2. if tmux exists but shell idle: start runner command in pane
3. if tmux exists and runner running: no-op
4. unless `--detached`: attach to session

### stop semantics

`agency stop <id>`:
1. `tmux send-keys -t agency:<run_id> C-c` (best-effort interrupt)
2. sets `needs_attention` flag regardless of whether interrupt succeeded
3. tmux session stays alive; `agency resume` can restart runner

`agency kill <id>`:
- `tmux kill-session -t agency:<run_id>`
- workspace persists

---

## 15) concurrency

v1: **single-writer model**. agency refuses concurrent mutation on the same run.

implementation: coarse repo-level lock file (`${AGENCY_DATA_DIR}/repos/<repo_id>/.lock`). if lock held, error `E_REPO_LOCKED`.

---

## 16) invariants

- never modify parent working tree silently
- never merge without human confirmation
- never create workspace without agency.json
- never create PR for empty diff (0 commits ahead)
- never start run if parent dirty or inside worktree
- never run scripts inside runner tmux pane

---

## 17) deferred (post-v1)

- interactive tui
- report_mode: repo_file (committed reports)
- manual status override (agency mark)
- parent-behind-origin gate
- runner pid inspection
- agency gc (automated cleanup)
- auto-update / self-update
- linux distro packages
